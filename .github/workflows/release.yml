name: Release Workflow

on:
  push:
    branches: [ 'release/**' ]
  pull_request:
    branches: [ 'release/**' ]

env:
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Backend tests
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        
    - name: Run backend tests
      run: |
        cd backend
        ./mvnw clean test
    
    # Frontend tests
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm install
        
    - name: Run frontend tests
      run: |
        cd frontend
        npm run lint
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build

    # Docker build
    - name: Build with Docker Compose
      run: docker compose build

  notify-feature-merge:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'feature/')
    
    steps:
    - name: Discord Feature Merge Notification
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
        status: success
        title: "ğŸ”€ Feature Ready for Release"
        description: |
          **Feature:** `${{ github.head_ref }}`
          **Target:** `${{ github.base_ref }}`
          **Author:** ${{ github.actor }}
          **PR:** #${{ github.event.number }}
          
          ğŸ¯ All tests passed
          ğŸ³ Docker build successful
          âœ… Ready for merge into release branch
        color: 0x00ff00
        username: "Squad Ride Bot"
        avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

  notify-release-update:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    
    steps:
    - name: Discord Release Update Notification
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
        status: success
        title: "ğŸ“¦ Release Branch Updated"
        description: |
          **Release Branch:** `${{ github.ref_name }}`
          **Commit:** `${{ github.sha }}`
          **Author:** ${{ github.actor }}
          
          ğŸ¯ All tests passed
          ğŸ³ Docker build successful
          ğŸš€ Release branch ready for production merge
        color: 0x9932cc
        username: "Squad Ride Bot"
        avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"